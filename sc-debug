#!/bin/bash

# --- RENK AYARLARI ---
CYAN='\e[1;36m'
GREEN='\e[1;32m'
RED='\e[1;31m'
BLUE='\e[1;34m'
YELLOW='\e[1;33m'
NC='\e[0m' # No Color

# Argümanları al (sc-hotspot'tan geliyor)
INTERFACE="${1:-wlo1}"
TARGET_SSID="$2"
TARGET_PASS="$3"

clear

# 1. DEBUG ASCII ART (SİNİRLİ TUX)
echo -e "${RED}"
cat << "EOF"

                                         @@@@%*+===*%%@@+++  ++
                                       @@=              =+* *+++
                                     @@=                =++ :+++
                                    @@:                -++:  =++++
                                    @=               =++=.
                                   @@                 :   =+++=#@
                        @@%%@@     @#                   .++=.:=+++
                      @@:  =@@     @*  .=.   %-%=   .+#+ ::    :@
                      @:  =@@@%=@  @+  #%%#.  @:  -#%%%#*      :@
                     @@:   :=. :@  @* :@:.-@* *..%@+:+=@@-      @@
            @@@@@   @%.       .@@  @* :#  @=@   -@*   % @%      %@
           @%   -@@@:    -%#%@@    @#  @=  *%%%#*@%    #@%      #@
           @:   +=:%:*@-@@         @%  :#*%*%%%%%%%%=  =%.      =@
          @#  :@= .@. :@@          @@  -%%%%%%%%%%%%%%#=        :@
          @+=@*    @:  =@          @@ :%%%%%%%%%%%%%%%%%%%.      %@
          @@#.    *@.  :@          @@..#%%%%%%%%%#=-=**=:%- ==   .@@
         @%.    -@:    *@           @:         .+%%%#: #@.   %@@  .@@
   @@@+==:    :@+     *@           @%  @= :#%%%%*- :#@@@@#    .:   .@@
  @@        .@%       .@@         @*  =@@*       *@@@@@@@@@.         @@
  @= :%+.   @@@#        =@@@    @@=  =@@@@@:  .#@@@@@@@@@@@@:         @@
  @@@@ @#  .@@ @:          .#@@*    -@@@@@@@@@@@@@@@@@@@@@@@%          %@
     @@:  :@@  @@=*                 %@@@@@@@@@@@@@@@@@@@@@@@@=          =@@
     @@@@@@     @:@.               :%@@@@@@@@**@@@@@@@@@@@@*%*    %-      @@
                @@.@.              .***%@@@@@*%@@@@@@@@@**%%**+    +@      #@
                 @%+@              *@@@@@@@@@#@@@@@@@@@@@@@@@##+    -@.     *@
                  @%:@:          -@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%+    =@.     *@
                   @@==%:       -@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=    *@      @@
                     @@@*+*@-  :@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@     %=     .@
                          @%   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=    +%      *@
                          @-  @@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@@@#    .@.     .@
                         @@  -@@@@@@@@@@@@@@*@@@@@@@@@@@@@@@@@@@@@%     @       @@
                         @%  %@@@@@@@@@@@@@@*@@@@@@@@@@@@@@@@@@@@@%    -*       -@
                         @%  @@@@@@@@@@@@@@@*@@@@@@@@@@@@@@@@@@@@@%    %:        @@
                      @@@@@. @@@@@@@@@@@@@@@*@@@@@@@@@@@@@@@@@@@@@@%###%@*.      @@
                    @@:   :#:@@@@@@@@@@@@@@@*@@@@@@@@@@@@@@@@@@@@@@              @
                    @%%%%%%:=@@@@@@@@@@@@@@@*@@@@@@@@@@@@@@@@@@%=:.            .@@
                   @*+%%%%%%# %@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@% *%#           =@@@
                  @@.*%%%%%%%%:+@@@@@@@@@@@@@#@@@@@@@@@@@@@@@@*:%%%#        =%%%%=@
           @@@@@@%: =%%%%%%%%%%*:@@@@@@@@@@@@%@@@@@@@@@@@@@@@@#:%%%%%*.  -#%%%%%+.@
          @%:%%%##%%%%%%%%%%%%%%#.@@@@@@@@@@@@@@@@@@@@@@@@@@@@#:%%%%%%%%%%%%%%%%% #@
          @+:%%%%%%%%%%%%%%%%%%%%%:%@@@@@@@@@@@@@@@@@@@@@@@@@@# %%%%%%%%%%%%%%%%%: :@@
          @% -%%%%%%%%%%%%%%%%%%%%%:%@@@@@@@@@@@@@@@@@@@@@@@@@* +%%%%%%%%%%%%%%%%%*:..#@@
           @- *%%%%%%%%%%%%%%%%%%%%%=#@@@@@@@@@@@@@@@@@@@@@= +* :%%%%%%%%%%%%%%%%%%%%%%-+@
           @- *%%%%%%%%%%%%%%%%%%%%%%==@@@@@@@@@@@@@@@@@@%.  ** :%%%%%%%%%%%%%%%%%%%%%%=:@
          @% :%%%%%%%%%%%%%%%%%%%%%%%%=:@+.%@@@@@@@@@@%-     @= +%%%%%%%%%%%%%%%%%%%%+:%@
          @-=%%%%%%%%%%%%%%%%%%%%%%%%%# .@#                 +@. #%%%%%%%%%%%%%%#*- :*@@
          @-.-*%%%%%%%%%%%%%%%%%%%%%%%%  -@                 #% .%%%%%%%%%%%%*:  *@@@
           @@@*-:  .-*#%%%%%%%%%%%%%%%+  =                      +%%%%%%%%%=  =@@
               @@@@@@%#=. .:=*%%%%%%%=  .#@@@@@@@@@@@@@@@@@@@*   :%%%%%%:  #@@
                        @@@%=.        +@@                    @%.         +@@
                            @@@@%*=+%@@                       @@@%#***%@@@



                                       /$$$$$$   /$$$$$$
                                      /$$__  $$ /$$__  $$
                                     | $$  \__/| $$  \__/
                                     |  $$$$$$ | $$
                                      \____  $$| $$
                                      /$$  \ $$| $$    $$
                                     |  $$$$$$/|  $$$$$$/
                                      \______/  \______/



 /$$$$$$$            /$$                                 /$$      /$$                 /$$
| $$__  $$          | $$                                | $$$    /$$$                | $$
| $$  \ $$  /$$$$$$ | $$$$$$$  /$$   /$$  /$$$$$$       | $$$$  /$$$$  /$$$$$$   /$$$$$$$  /$$$$$$
| $$  | $$ /$$__  $$| $$__  $$| $$  | $$ /$$__  $$      | $$ $$/$$ $$ /$$__  $$ /$$__  $$ /$$__  $$
| $$  | $$| $$$$$$$$| $$  \ $$| $$  | $$| $$  \ $$      | $$  $$$| $$| $$  \ $$| $$  | $$| $$$$$$$$
| $$  | $$| $$_____/| $$  | $$| $$  | $$| $$  | $$      | $$\  $ | $$| $$  | $$| $$  | $$| $$_____/
| $$$$$$$/|  $$$$$$$| $$$$$$$/|  $$$$$$/|  $$$$$$$      | $$ \/  | $$|  $$$$$$/|  $$$$$$$|  $$$$$$$
|_______/  \_______/|_______/  \______/  \____  $$      |__/     |__/ \______/  \_______/ \_______/
                                         /$$  \ $$
                                        |  $$$$$$/
                                         \______/
EOF
echo -e "${NC}"

echo -e "${YELLOW}===============================================================${NC}"
echo -e "${RED}                   SC DEBUG - AĞ KURTARMA MODU                 ${NC}"
echo -e "${YELLOW}===============================================================${NC}\n"

CURRENT_SSID=$(iw dev $INTERFACE link | grep '\bSSID:' | sed 's/^.*SSID: //')

if [ -z "$CURRENT_SSID" ]; then
    echo -e "${RED}[!] Aktif bir ağ bağlantısı bulunamadı.${NC}"
    exit 1
fi

echo -e "${CYAN}[*] '$CURRENT_SSID' ağı için serbest (sivil) kanallar taranıyor...${NC}\n"

echo "BSSID | KANAL | HIZ | SİNYAL"
echo "---------------------------------"

# Sadece o anki ağın BSSID'lerini listele
mapfile -t ap_list < <(nmcli -t -f BSSID,CHAN,RATE,SIGNAL,SSID dev wifi | grep ":$CURRENT_SSID$" | grep -v '^\*' | awk -F':' '{print $1":"$2":"$3":"$4":"$5":"$6 " | Kanal: " $7 " | Hız: " $8 " | Sinyal: " $9}')

PS3=$'\nLütfen bağlanmak istediğiniz serbest kanalı (1-13 arası önerilir) seçin: '
select ap_choice in "${ap_list[@]}" "İptali Seç ve Çık"; do
    if [[ "$ap_choice" == "İptali Seç ve Çık" ]]; then
        echo -e "${RED}İşlem iptal edildi.${NC}"
        exit 0
    elif [[ -n "$ap_choice" ]]; then
        # \ kaçış karakterlerini temizle (MAC adresini düzeltir)
        SELECTED_BSSID=$(echo "$ap_choice" | awk '{print $1}' | sed 's/\\//g')
        SELECTED_CHAN=$(echo "$ap_choice" | awk '{print $4}')
        
        echo -e "\n${GREEN}[*] $SELECTED_BSSID adresine (Kanal $SELECTED_CHAN) kilitleniliyor...${NC}"
        
        # BSSID'yi kilitle
        nmcli con modify "$CURRENT_SSID" 802-11-wireless.bssid "$SELECTED_BSSID"
        
        # Bandı kanal değerine göre zorla
        if [ "$SELECTED_CHAN" -lt 14 ]; then
            nmcli con modify "$CURRENT_SSID" 802-11-wireless.band bg
        else
            nmcli con modify "$CURRENT_SSID" 802-11-wireless.band a
        fi
        
        echo -e "${BLUE}[*] Ağ bağdaştırıcısı yeni kanalda başlatılıyor...${NC}"
        nmcli con up "$CURRENT_SSID" > /dev/null 2>&1
        sleep 3 
        
        echo -e "${GREEN}[*] Sorun çözüldü! Ana betiğe (sc-hotspot) geri dönülüyor...${NC}"
        sleep 2
        
        # Ana betiğe geri dön. Dönüşte şifre sormaması için argümanları ve 
        # işlemi bitince temizlik yapması için CURRENT_SSID'yi paslıyoruz.
        DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"
        exec "$DIR/sc-hotspot" "$TARGET_SSID" "$TARGET_PASS" "$CURRENT_SSID"
        
        break
    else
        echo -e "${RED}Geçersiz seçim.${NC}"
    fi
done
